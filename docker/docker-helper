#!/bin/bash
#
# Helper for the Makefile to trigger Docker commands with the desired image.

usage() {
    echo "usage: $(basename $0) build|test|run <platform>"
    exit 1
}

test $# = 2 || usage

version=$(../scripts/autogen-version --short)
cmd=$1
platform=$2

if [ ! -e "Dockerfile.${platform}" ]; then
    echo "Dockerfile.${platform} does not exist"
    exit 1
fi

case "${cmd}" in
    build)
        # Try to fetch the base image. Even if the fetched image does not exactly
        # match our Dockerfile, we might still be able to reused some cached layers.
        docker pull "zeekurity/spicy-base-${platform}:${version}" || true

        DOCKER_BUILDKIT=1 docker build \
            -t "spicy-${platform}:${version}" \
            --cache-from "zeekurity/spicy-base-${platform}:${version}" \
            -f "Dockerfile.${platform}" .. || exit 1
        docker tag \
            "$(docker inspect --format='{{.Id}}' "spicy-${platform}:${version}")" \
            "spicy-${platform}:latest"
        ;;

    test)
        docker run "spicy-${platform}:latest" /bin/sh -c "cd /opt/spicy/src/tests && SPICY_INSTALLATION_DIRECTORY=/opt/spicy btest -a installation -q -j -d"
        ;;

    run)
        docker run --cap-add SYS_PTRACE -i -t "spicy-${platform}:latest" /bin/bash
        ;;

    *) usage;;
esac
